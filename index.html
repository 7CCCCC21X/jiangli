<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>BSC 交易赛分配表</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="color-scheme" content="light dark">
<style>
:root{--bg:#2f2f2f;--text:#e5e7eb;--primary:#60a5fa;--green:#6ee7b7;--blue:#60a5fa;--pink:#f472b6;--redbg:#7f1d1d}
@media(prefers-color-scheme:light){
  :root{--bg:#f9f9f9;--text:#222;--primary:#0078d4;--green:#16a34a;--blue:#2563eb;--pink:#ec4899;--redbg:#b91c1c}
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,Segoe UI,PingFang SC,Helvetica,Arial,sans-serif}
.topbar{display:flex;justify-content:space-between;align-items:center;background:#444;padding:6px 12px;font-size:14px}
.topbar a{color:#fff;text-decoration:none}
.topbar button{background:var(--primary);color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:13px}
h2{margin:14px 0;text-align:center;font-size:20px;color:var(--primary)}
.container{max-width:100%;margin:0 auto 20px;overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:14px;min-width:1200px}
th,td{border:1px solid #555;padding:6px 8px;text-align:center;white-space:nowrap}
th{background:#393939;color:#fff;font-weight:600;position:sticky;top:0;z-index:1}
td:nth-child(1){font-weight:700}
.green{color:var(--green)} .blue{color:var(--blue)} .pink{color:var(--pink)}
.redbg{background:var(--redbg);color:#fff}
.total{background:#000;color:#ffa500;font-weight:700;font-size:16px}
.note{font-size:12px;color:#a1a1aa;text-align:right;margin:4px 14px 0}
a.addr{color:#9dd6ff;text-decoration:none}
a.addr:hover{text-decoration:underline}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#2b2b2b;margin-right:6px}
</style>
</head>
<body>
  <div class="topbar">
    <span>推特：<a href="https://x.com/0xXIAOc" target="_blank">@0xXIAOc</a></span>
    <button id="refreshBtn">立即刷新</button>
  </div>

  <h2>BSC交易赛分配表格</h2>

  <div class="container">
    <table id="sheet">
      <thead>
        <tr>
          <th>代币</th>
          <th>奖励(U)</th>
          <th>现价(U)</th>
          <th>排名要求</th>
          <th>结束时间</th>
          <th>推荐购买金额</th>
          <th>限价单/1000</th>
          <th>入门门槛</th>
          <th>当前成本</th>
          <th>备注</th>
          <th>链/链接</th>
          <th>奖励代币数量</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="12" class="total">收益总和：<span id="totalUSD">--</span></td></tr>
      </tfoot>
    </table>
  </div>

  <!-- 按你的要求，这里固定显示 8/24，不跟随刷新时间变化 -->
  <p class="note" id="updateInfo">更新时间：8/24</p>

<script>
/* ===== 常量与工具 ===== */
var QUOTE_WHITELIST_PRIMARY = ['USDT','USDC'];   // 主筛选：仅美元稳定币
var QUOTE_WHITELIST_FALLBACK_DEFAULT = ['BUSD','WBNB']; // 通用兜底（EVM/BSC）
var MIN_LIQ_USD = 5000;

// 不同链的报价兜底（当 USDT/USDC 不满足时）
var FALLBACK_BY_CHAIN = {
  bsc: ['BUSD','WBNB'],
  solana: ['SOL','WSOL','wSOL'] // Sol 链常见报价
};

// EVM 链列表，用于地址规范化（EVM 地址可安全小写）
var EVM_CHAINS = ['bsc','ethereum','base','arbitrum','polygon','optimism','avalanche','fantom','blast','linea','scroll'];

/* 数字格式化（带千分位） */
function fmt(n){ return (n==null || isNaN(n)) ? '--' : Number(n).toLocaleString(); }

/* 从字符串中提取数值（如 "0.25 U" -> 0.25） */
function toNumber(val){
  if(val==null) return 0;
  if(typeof val==='number') return val;
  var m = String(val).replace(/,/g,'').match(/-?\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : 0;
}

/* 地址规范化（Sol 等非 EVM 链保持大小写；EVM 链转小写） */
function normalizeAddr(addr, chain){
  if(!addr) return '';
  return EVM_CHAINS.indexOf(chain)>=0 ? String(addr).toLowerCase() : String(addr);
}

/* 链名徽章与浏览器链接 */
function chainLabel(chain){
  if(chain==='solana') return 'SOL';
  if(chain==='bsc') return 'BSC';
  return (chain||'—').toUpperCase();
}
function getExplorerLink(chain, addr){
  if(!addr) return '#';
  if(chain==='solana') return 'https://solscan.io/token/'+addr;
  if(chain==='bsc') return 'https://bscscan.com/token/'+addr;
  return '#';
}

/* ===== 数据（保持原顺序并追加 4 个新币） ===== */
var rows = [

  /* ===== 新增四个 BSC 代币 ===== */
  {chain:'bsc',    sym:'BUS',    addr:'0x1aecab957bad4c6e36dd29c3d3bb470c4c29768a', qty:'530', rank:'—', end:'—', buy:'待测试', limitPer1000:'待测试', entry:'0', remark:''},
  {chain:'bsc',    sym:'BAY',    addr:'0xa7bef5abd9265ab97ee43d2fc4a56e0ba25aca25', qty:'588', rank:'—', end:'—', buy:'待测试', limitPer1000:'待测试', entry:'0', remark:''},
  {chain:'bsc',    sym:'JCT',    addr:'0xea37a8de1de2d9d10772eeb569e28bfa5cb17707', qty:'21176', rank:'—', end:'—', buy:'待测试', limitPer1000:'待测试', entry:'0', remark:''},
  {chain:'bsc',    sym:'DGRAM',    addr:'0x49c6c91ec839a581de2b882e868494215250ee59', qty:'10588', rank:'—', end:'—', buy:'待测试', limitPer1000:'待测试', entry:'0', remark:''},
  {chain:'bsc',    sym:'LAB',    addr:'0x7ec43cf65f1663f820427c62a5780b8f2e25593a', qty:'650', rank:'—', end:'—', buy:'待测试', limitPer1000:'待测试', entry:'0', remark:''}
];

/* ===== 渲染表格骨架 ===== */
var tbody = document.querySelector('#sheet tbody');
function shortAddr(a){ return a ? (a.slice(0,6)+'…'+a.slice(-4)) : '—'; }
function renderSkeleton(){
  tbody.innerHTML = rows.map(function(r,i){
    var linkHtml = r.addr
      ? ('<span class="badge">'+chainLabel(r.chain)+'</span>'
         + '<a class="addr" href="'+getExplorerLink(r.chain, r.addr)+'" target="_blank">'+shortAddr(r.addr)+'</a>')
      : '—';
    return (
      '<tr id="r-'+i+'">'+
        '<td>'+r.sym+'</td>'+
        '<td class="green" data-reward>--</td>'+
        '<td data-price>--</td>'+
        '<td class="redbg">'+(r.rank||'—')+'</td>'+
        '<td>'+(r.end||'—')+'</td>'+
        '<td class="blue">'+(r.buy==null ? '—' : r.buy)+'</td>'+
        '<td class="pink">'+(r.limitPer1000==null ? '—' : r.limitPer1000)+'</td>'+
        '<td>'+fmt(toNumber(r.entry))+'</td>'+
        '<td data-cost>--</td>'+
        '<td>'+(r.remark||'—')+'</td>'+
        '<td>'+linkHtml+'</td>'+
        '<td>'+fmt(toNumber(r.qty))+'</td>'+
      '</tr>'
    );
  }).join('');
}
renderSkeleton();

/* ===== 成本计算（入门门槛/1000 × 限价单/1000） ===== */
function updateCostRow(i){
  var r = rows[i];
  var entry = toNumber(r.entry);
  var per1000 = toNumber(r.limitPer1000);
  var cost = (entry && per1000) ? (entry/1000)*per1000 : 0;
  var rowEl = document.getElementById('r-'+i);
  if(rowEl){
    rowEl.querySelector('[data-cost]').textContent = cost ? (cost.toFixed(4)+' U') : '--';
  }
}

/* ===== 价格抓取（DexScreener） ===== */
async function priceFromDexScreener(addr, chain, preferList){
  preferList = preferList || QUOTE_WHITELIST_PRIMARY;
  var tokenParam = normalizeAddr(addr, chain);
  var url = 'https://api.dexscreener.com/latest/dex/tokens/'+encodeURIComponent(tokenParam);
  try{
    var resp = await fetch(url);
    var json = await resp.json();
    var pairs = (json && Array.isArray(json.pairs)) ? json.pairs : [];

    function pick(quotes){
      return pairs
        .filter(function(p){
          var liqUsd = (p && p.liquidity && p.liquidity.usd) || 0;
          var quoteSym = p && p.quoteToken && p.quoteToken.symbol;
          var priceUsd = p && p.priceUsd;
          return p && p.chainId===chain
            && priceUsd && !isNaN(+priceUsd)
            && quotes.indexOf(quoteSym)!==-1
            && liqUsd > MIN_LIQ_USD;
        })
        .sort(function(a,b){
          var la = (a && a.liquidity && a.liquidity.usd) || 0;
          var lb = (b && b.liquidity && b.liquidity.usd) || 0;
          return lb - la;
        })[0];
    }

    var best = pick(preferList);
    if(!best && preferList===QUOTE_WHITELIST_PRIMARY){
      var fb = (FALLBACK_BY_CHAIN[chain] || QUOTE_WHITELIST_FALLBACK_DEFAULT);
      best = pick(fb);
    }
    return best ? +best.priceUsd : null;
  }catch(e){
    return null;
  }
}

/* ===== 刷新逻辑：抓价 → 算奖励 → 汇总 ===== */
var totalUSD = document.getElementById('totalUSD');

async function refresh(){
  var sum = 0;
  for(var i=0;i<rows.length;i++){
    var r = rows[i];
    // 计算当前成本
    updateCostRow(i);

    // 抓现价（按链过滤）
    var price = await priceFromDexScreener(r.addr, r.chain);
    var rowEl = document.getElementById('r-'+i);
    if(rowEl){
      rowEl.querySelector('[data-price]').textContent = price ? (price.toFixed(6)+' U') : '--';

      // 奖励(U) = 现价 × 数量
      var qty = toNumber(r.qty);
      var reward = (price && qty) ? price * qty : 0;
      rowEl.querySelector('[data-reward]').textContent = reward ? (reward.toFixed(2)+' U') : '--';
      sum += reward || 0;
    }
  }
  totalUSD.textContent = sum.toFixed(2)+' U';
}

// 首次渲染 + 定时刷新
refresh();
document.getElementById('refreshBtn').addEventListener('click', refresh);
setInterval(refresh, 60000); // 每分钟刷新
</script>
</body>
</html>
